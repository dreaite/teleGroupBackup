#!/bin/bash
# Git post-merge hook
# 当 dev 分支合并到 master 时，自动部署/重启 systemd 服务

# 获取当前分支
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# 仅在 master 分支执行
if [ "$CURRENT_BRANCH" != "master" ]; then
    exit 0
fi

# 检查是否是合并操作（MERGE_HEAD 文件存在）
if [ ! -f .git/MERGE_HEAD ]; then
    exit 0
fi

echo "========================================="
echo "🤖 检测到 master 分支合并，准备部署服务..."
echo "========================================="

# 查找 deploy 目录下所有 .service 文件
DEPLOY_DIR="deploy"
if [ ! -d "$DEPLOY_DIR" ]; then
    echo "❌ 错误: $DEPLOY_DIR 目录不存在"
    exit 1
fi

# 统计变量
TOTAL_SERVICES=0
SUCCESS_COUNT=0
FAIL_COUNT=0
FAILED_SERVICES=()

# 遍历所有 .service 文件
for SERVICE_FILE in "$DEPLOY_DIR"/*.service; do
    # 检查是否找到文件（避免通配符没匹配到的情况）
    if [ ! -f "$SERVICE_FILE" ]; then
        continue
    fi
    
    TOTAL_SERVICES=$((TOTAL_SERVICES + 1))
    
    # 从文件名提取服务名（去掉路径和 .service 后缀）
    SERVICE_NAME=$(basename "$SERVICE_FILE" .service)
    SYSTEMD_PATH="/etc/systemd/system/${SERVICE_NAME}.service"
    
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "📦 处理服务: $SERVICE_NAME"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    # 检查 systemd 服务是否已安装
    if systemctl list-unit-files | grep -q "^${SERVICE_NAME}.service"; then
        echo "✅ 服务已存在，准备重启..."
        
        # 停止服务
        echo "⏸️  停止服务: $SERVICE_NAME"
        sudo systemctl stop "$SERVICE_NAME"
        
        # 更新服务文件
        echo "📝 更新服务文件到 $SYSTEMD_PATH"
        sudo cp "$SERVICE_FILE" "$SYSTEMD_PATH"
        
        # 重新加载 systemd
        echo "🔄 重新加载 systemd 配置"
        sudo systemctl daemon-reload
        
        # 启动服务
        echo "▶️  启动服务: $SERVICE_NAME"
        sudo systemctl start "$SERVICE_NAME"
        
        # 检查状态
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            echo "✅ 服务重启成功！"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        else
            echo "❌ 服务启动失败"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            FAILED_SERVICES+=("$SERVICE_NAME")
            echo "   查看日志: sudo journalctl -u $SERVICE_NAME -n 50"
        fi
    else
        echo "🆕 服务不存在，准备首次安装..."
        
        # 复制服务文件
        echo "📝 复制服务文件到 $SYSTEMD_PATH"
        sudo cp "$SERVICE_FILE" "$SYSTEMD_PATH"
        
        # 重新加载 systemd
        echo "🔄 重新加载 systemd 配置"
        sudo systemctl daemon-reload
        
        # 启用开机自启
        echo "🔧 设置开机自启"
        sudo systemctl enable "$SERVICE_NAME"
        
        # 启动服务
        echo "▶️  启动服务: $SERVICE_NAME"
        sudo systemctl start "$SERVICE_NAME"
        
        # 检查状态
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            echo "✅ 服务安装并启动成功！"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        else
            echo "❌ 服务启动失败"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            FAILED_SERVICES+=("$SERVICE_NAME")
            echo "   查看日志: sudo journalctl -u $SERVICE_NAME -n 50"
        fi
    fi
done

echo ""
echo "========================================="
echo "🎉 部署完成！"
echo "========================================="
echo ""
echo "📊 部署汇总:"
echo "   总服务数: $TOTAL_SERVICES"
echo "   成功: $SUCCESS_COUNT"
echo "   失败: $FAIL_COUNT"

if [ $FAIL_COUNT -gt 0 ]; then
    echo ""
    echo "❌ 失败的服务:"
    for service in "${FAILED_SERVICES[@]}"; do
        echo "   - $service"
        echo "     日志: sudo journalctl -u $service -n 50"
    done
fi

if [ $SUCCESS_COUNT -gt 0 ]; then
    echo ""
    echo "� 查看所有服务状态:"
    echo "   sudo systemctl status 'dreaife_*' --no-pager"
    echo ""
    echo "📊 查看日志 (示例):"
    echo "   应用日志: sudo tail -f /logs/bot/<service-name>/telebot.log"
    echo "   系统日志: sudo journalctl -u <service-name> -f"
fi

echo ""

# 如果有失败的服务，返回非零退出码
if [ $FAIL_COUNT -gt 0 ]; then
    exit 1
fi
